#include <stdint.h>
#include <string.h>
#include "cx.h"

#include "signTx.h"
#include "getPublicKeys.h"

ux_state_t G_ux;
uint8_t G_io_apdu_buffer[IO_APDU_BUFFER_SIZE];

#ifdef DEVEL
#include "utils.h"
unsigned int app_stack_canary = APP_STACK_CANARY_MAGIC;
#endif

void signTx_handleAPDU_no_throw(uint8_t p1, uint8_t p2, uint8_t *wireBuffer, size_t wireSize, bool isNewCall) {
      BEGIN_TRY {
        TRY {
            signTx_handleAPDU(p1, p2, wireBuffer, wireSize, isNewCall);
            }
        CATCH_ALL {
        } 
        FINALLY {
        }
    } END_TRY;
}

#if 0
/*
d721020024d25007ac021c5c18ca0ed4159497bdf072885342f6f69d8ea8123914909509fd00000000
d72103304a0100000039010c3dad3a4d39ff842118de330532832976ed3745706ed4683c0865d7afe6e51594bf57d3abb6226f8325595ebac4775c7b9e860bb0acbe2700000000002b2cbd00000000
d721033300
d7210400080000000000029a03
d7210500080000000001bd47cf
d7210a0000
*/
int main() {
  uint8_t Data[] = {1, 0, 0x1d, 0x01, 0x2d, 0x96, 0x4a, 0x09, 0x02, 0x01, 0x01, 0x03, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x01,
    0x02, 0x00, 0x24, 0xD2, 0x50, 0x07, 0xAC, 0x02, 0x1C, 0x5C,
    0x18, 0xCA, 0x0E, 0xD4, 0x15, 0x94, 0x97, 0xBD, 0xF0, 0x72, 0x88, 0x53,
    0x42, 0xF6, 0xF6, 0x9D, 0x8E, 0xA8, 0x12, 0x39, 0x14, 0x90, 0x95, 0x09,
    0xFD, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x30, 0x4a, 0x01, 0x00, 0x00, 0x00, 0x39, 0x01, 0x0C,
    0x3D, 0xAD, 0x3A, 0x4D, 0x39, 0xFF, 0x84, 0x21, 0x18, 0xDE, 0x33, 0x05,
    0x32, 0x83, 0x29, 0x76, 0xED, 0x37, 0x45, 0x70, 0x6E, 0xD4, 0x68, 0x3C,
    0x08, 0x65, 0xD7, 0xAF, 0xE6, 0xE5, 0x15, 0x94, 0xBF, 0x57, 0xD3, 0xAB,
    0xB6, 0x22, 0x6F, 0x83, 0x25, 0x59, 0x5E, 0xBA, 0xC4, 0x77, 0x5C, 0x7B,
    0x9E, 0x86, 0x0B, 0xB0, 0xAC, 0xBE, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x2B, 0x2C, 0xBD, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x33, 0x00,
    0x04, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x9a, 0x03,
    0x05, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x01, 0xbd, 0x47, 0xcf,
    0x0a, 0x00, 0x00};
  size_t Size = sizeof(Data);
#else
int LLVMFuzzerTestOneInput(const uint8_t *Data, size_t Size) {
#endif

  UX_INIT();

  bool is_first = true;
  uint8_t * input = Data;
  size_t size = Size;
  while ((size > 4) && (input[2] < size-4)) {
    io_state = IO_EXPECT_NONE;
    signTx_handleAPDU_no_throw(input[0], input[1], &input[3], input[2], is_first);
    is_first = false;
    size -= input[2] + 3;
    input += input[2] + 3;
  }
  return 0;
}